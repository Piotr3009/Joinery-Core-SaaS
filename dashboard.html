<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/jpeg" href="landingimg/logo black tlo.jpeg">
    <title>Joinery Core - Operational System - Production Manager</title>
    <link rel="stylesheet" href="css/styles.css?v=14">
    
    <!-- Supabase -->
    <script src="js/api-client.js"></script>
    <script src="js/toast.js"></script>
    
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="js/menu.js"></script>
    <script src="js/permissions.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="app-title">
                <img src="landingimg/logo.webp" alt="Joinery Core" style="height: 32px; width: auto; border-radius: 4px;">
                <span style="color: #888; font-size: 12px;">Production Manager</span>
            </div>
            <div class="navigation-links">
                <!-- Menu loaded by menu.js -->
            </div>
        </div>

        <!-- TUTAJ DALEJ TOOLBAR ITD... -->






        <!-- Toolbar -->
        <div class="toolbar" style="display: flex; align-items: center;">
            <div style="display: flex; gap: 10px;">
                <button class="toolbar-btn primary" onclick="addProject()" id="addProjectBtn">+ Add Project</button>
                <button class="toolbar-btn success" onclick="openMoveToArchiveModal()">Move to Archive</button>
                <button class="toolbar-btn" onclick="openPhaseManager()">Manage Phases</button>
            </div>
            
            <div style="position: absolute; left: 50%; transform: translateX(-50%); display: flex; gap: 10px;">
                <a href="today.html" class="toolbar-btn nav-link-today" style="font-weight: bold;">TODAY</a>
                <button class="toolbar-btn" onclick="shiftWeek(-1)">‚Üê Week</button>
                <button class="toolbar-btn" onclick="shiftWeek(1)">Week ‚Üí</button>
            </div>
        </div>
        
        <!-- Sort & Filter Bar -->
        <div class="toolbar" style="margin-top: 10px; padding: 8px 15px;">
            <!-- Sort buttons -->
            <span style="font-size: 11px; color: #999; margin-right: 8px;">Sort:</span>
            <button class="toolbar-btn sort-btn active" data-sort="number" onclick="setSortMode('number')" title="Sort by number">
                By Number
            </button>
            <button class="toolbar-btn sort-btn" data-sort="deadline" onclick="setSortMode('deadline')" title="Sort by deadline">
                By DL
            </button>
            <button class="toolbar-btn sort-btn" data-sort="timber" onclick="setSortMode('timber')" title="Sort by timber start date">
                By Timber
            </button>
            <button class="toolbar-btn sort-btn" data-sort="spray" onclick="setSortMode('spray')" title="Sort by spray start date">
                By Spray
            </button>
            
            <div style="width: 1px; height: 20px; background: #555; margin: 0 10px;"></div>
            
            <!-- Filter dropdowns -->
            <span style="font-size: 11px; color: #999; margin-right: 8px;">View:</span>

            <!-- Production Schedule (Timber + Glazing + Spray combined) -->
            <div class="filter-dropdown" style="display: inline-block; position: relative;">
                <button class="toolbar-btn" onclick="toggleFilterDropdown('productionFilter')">
                    Production Schedule ‚ñº
                </button>
                <div class="filter-menu" id="productionFilter" style="display: none;">
                    <button onclick="setProductionFilter('all')">All Production Workers</button>
                    <div style="height: 1px; background: #444; margin: 5px 0;"></div>
                    <div id="productionWorkersList"></div>
                </div>
            </div>

            <div class="filter-dropdown" style="display: inline-block; position: relative; margin-left: 5px;">
                <button class="toolbar-btn" onclick="toggleFilterDropdown('timberFilter')">
                    Timber/Glazing Schedule ‚ñº
                </button>
                <div class="filter-menu" id="timberFilter" style="display: none;">
                    <button onclick="setTimberFilter('all')">All Timber Workers</button>
                    <div style="height: 1px; background: #444; margin: 5px 0;"></div>
                    <div id="timberWorkersList"></div>
                </div>
            </div>
            
            <div class="filter-dropdown" style="display: inline-block; position: relative; margin-left: 5px;">
                <button class="toolbar-btn" onclick="toggleFilterDropdown('sprayFilter')">
                    Spray Schedule ‚ñº
                </button>
                <div class="filter-menu" id="sprayFilter" style="display: none;">
                    <button onclick="setSprayFilter('all')">All Spray Workers</button>
                    <div style="height: 1px; background: #444; margin: 5px 0;"></div>
                    <div id="sprayWorkersList"></div>
                </div>
            </div>
            
            <button class="toolbar-btn" onclick="clearFilters()" style="margin-left: 5px;">
                Show All
            </button>

            
        </div>

        <!-- Chart -->
        <div class="chart-wrapper">
            <div class="chart-header">
                <div class="project-header">
                    <div class="header-column header-number">No.</div>
                    <div class="header-column-divider"></div>
                    <div class="header-column header-type">Type</div>
                    <div class="header-column-divider"></div>
                    <div class="header-column header-name">Project</div>
                    <div class="header-column-divider"></div>
                    <div class="header-column header-deadline">Deadline</div>
                    <div class="header-column-divider"></div>
                    <div class="header-column header-actions">Actions</div>
                </div>
                <div class="timeline-header" id="timelineHeader">
                    <!-- Timeline will be generated here -->
                </div>
            </div>
            <div class="chart-body" id="chartBody">
                <!-- Projects will be rendered here -->
            </div>
        </div>
    </div>

    <!-- Add/Edit Project Modal -->
    <div class="modal" id="projectModal">
        <div class="modal-content">
            <div class="modal-header" id="projectModalTitle">Add Project</div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Project Number</label>
                    <input type="text" id="projectNumber" placeholder="e.g. 001/2025">
                </div>
                
                <div class="form-group">
                    <label>Project Type</label>
                    <div class="type-selector">
                        <div class="type-option" data-type="sash" onclick="selectProjectType('sash')">
                            <div class="type-icon">
                                <svg viewBox="0 0 100 100" width="40" height="40" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <defs><linearGradient id="gold-sash-d" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#A3E4D7"/><stop offset="50%" stop-color="#58D68D"/><stop offset="100%" stop-color="#27AE60"/></linearGradient></defs>
                                    <g transform="translate(15, 10)" stroke="url(#gold-sash-d)" fill="none">
                                        <rect x="0" y="0" width="70" height="80" stroke-width="2"/>
                                        <rect x="8" y="6" width="54" height="35" stroke-width="2"/>
                                        <path d="M8 23 H62 M35 6 V41" stroke-width="1" opacity="0.5"/>
                                        <rect x="4" y="44" width="62" height="32" stroke-width="3"/>
                                        <path d="M4 60 H66 M35 44 V76" stroke-width="1.5"/>
                                        <rect x="30" y="70" width="10" height="3" fill="url(#gold-sash-d)" rx="1"/>
                                    </g>
                                </svg>
                            </div>
                            <div class="type-name">Sash Window</div>
                        </div>
                        <div class="type-option" data-type="casement" onclick="selectProjectType('casement')">
                            <div class="type-icon">
                                <svg viewBox="0 0 100 100" width="40" height="40" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <defs><linearGradient id="gold-case-d" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#A3E4D7"/><stop offset="50%" stop-color="#58D68D"/><stop offset="100%" stop-color="#27AE60"/></linearGradient></defs>
                                    <g transform="translate(10, 10)" stroke="url(#gold-case-d)" fill="none">
                                        <rect x="0" y="0" width="55" height="80" stroke-width="1.5" opacity="0.4"/>
                                        <path d="M30 5 L80 15 L80 75 L30 85 Z" stroke-width="2.5"/>
                                        <path d="M38 14 L72 22 L72 68 L38 76 Z" stroke-width="1" opacity="0.5"/>
                                        <rect x="70" y="42" width="3" height="14" fill="url(#gold-case-d)" rx="1"/>
                                    </g>
                                </svg>
                            </div>
                            <div class="type-name">Casement</div>
                        </div>
                        <div class="type-option" data-type="kitchen" onclick="selectProjectType('kitchen')">
                            <div class="type-icon">
                                <svg viewBox="0 0 100 100" width="40" height="40" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <defs><linearGradient id="gold-kit-d" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#A3E4D7"/><stop offset="50%" stop-color="#58D68D"/><stop offset="100%" stop-color="#27AE60"/></linearGradient></defs>
                                    <g transform="translate(5, 10)" stroke="url(#gold-kit-d)" fill="none">
                                        <rect x="0" y="6" width="22" height="64" stroke-width="2"/>
                                        <path d="M22 6 L29 1 L29 65 L22 70" stroke-width="1.5"/>
                                        <rect x="3" y="10" width="16" height="18" stroke-width="0.8" opacity="0.5"/>
                                        <rect x="3" y="32" width="16" height="34" stroke-width="0.8" opacity="0.5"/>
                                        <circle cx="17" cy="19" r="2" fill="url(#gold-kit-d)"/>
                                        <circle cx="17" cy="49" r="2" fill="url(#gold-kit-d)"/>
                                        <path d="M24 38 L90 38 L97 33 L31 33 Z" stroke-width="2" fill="url(#gold-kit-d)" opacity="0.4"/>
                                        <rect x="26" y="40" width="22" height="32" stroke-width="2"/>
                                        <path d="M48 40 L55 35 L55 67 L48 72" stroke-width="1.5"/>
                                        <line x1="37" y1="40" x2="37" y2="72" stroke-width="1"/>
                                        <circle cx="33" cy="56" r="2" fill="url(#gold-kit-d)"/>
                                        <circle cx="41" cy="56" r="2" fill="url(#gold-kit-d)"/>
                                        <rect x="50" y="40" width="22" height="32" stroke-width="2"/>
                                        <path d="M72 40 L79 35 L79 67 L72 72" stroke-width="1.5"/>
                                        <line x1="50" y1="50" x2="72" y2="50" stroke-width="1"/>
                                        <line x1="50" y1="60" x2="72" y2="60" stroke-width="1"/>
                                        <line x1="56" y1="44" x2="66" y2="44" stroke-width="2"/>
                                        <line x1="56" y1="54" x2="66" y2="54" stroke-width="2"/>
                                        <line x1="56" y1="65" x2="66" y2="65" stroke-width="2"/>
                                    </g>
                                </svg>
                            </div>
                            <div class="type-name">Kitchen</div>
                        </div>
                        <div class="type-option" data-type="wardrobe" onclick="selectProjectType('wardrobe')">
                            <div class="type-icon">
                                <svg viewBox="0 0 100 100" width="40" height="40" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <defs><linearGradient id="gold-ward-d" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#A3E4D7"/><stop offset="50%" stop-color="#58D68D"/><stop offset="100%" stop-color="#27AE60"/></linearGradient></defs>
                                    <g transform="translate(20, 5)" stroke="url(#gold-ward-d)" fill="none">
                                        <rect x="0" y="0" width="60" height="90" stroke-width="2.5"/>
                                        <line x1="30" y1="0" x2="30" y2="90" stroke-width="1.5"/>
                                        <rect x="24" y="35" width="3" height="20" rx="1" fill="url(#gold-ward-d)"/>
                                        <rect x="33" y="35" width="3" height="20" rx="1" fill="url(#gold-ward-d)"/>
                                    </g>
                                </svg>
                            </div>
                            <div class="type-name">Wardrobe</div>
                        </div>
                        <div class="type-option" data-type="partition" onclick="selectProjectType('partition')">
                            <div class="type-icon">
                                <svg viewBox="0 0 100 100" width="40" height="40" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <defs><linearGradient id="gold-part-d" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#A3E4D7"/><stop offset="50%" stop-color="#58D68D"/><stop offset="100%" stop-color="#27AE60"/></linearGradient></defs>
                                    <g transform="translate(10, 15)" stroke="url(#gold-part-d)" fill="none">
                                        <path d="M5 15 L45 5 L45 65 L5 75 Z" stroke-width="1.5"/>
                                        <path d="M25 10 L65 0 L65 60 L25 70 Z" stroke-width="2.5"/>
                                        <path d="M45 5 L85 -5 L85 55 L45 65 Z" stroke-width="1.5"/>
                                        <rect x="58" y="25" width="4" height="8" fill="url(#gold-part-d)"/>
                                    </g>
                                </svg>
                            </div>
                            <div class="type-name">Partition Wall</div>
                        </div>
                        <div class="type-option" data-type="externalSpray" onclick="selectProjectType('externalSpray')">
                            <div class="type-icon">
                                <svg viewBox="0 0 100 100" width="40" height="40" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <defs><linearGradient id="gold-spray-d" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#A3E4D7"/><stop offset="50%" stop-color="#58D68D"/><stop offset="100%" stop-color="#27AE60"/></linearGradient></defs>
                                    <g transform="translate(15, 15)" stroke="url(#gold-spray-d)" fill="none">
                                        <path d="M0 40 L15 40 L20 25 L45 25 Q55 25 55 38 L55 50 L20 50 L15 70 L0 70 Z" stroke-width="2" fill="url(#gold-spray-d)" opacity="0.3"/>
                                        <path d="M22 25 L12 0 L42 0 L32 25" stroke-width="2"/>
                                        <rect x="55" y="32" width="12" height="12" rx="2" fill="url(#gold-spray-d)"/>
                                        <circle cx="8" cy="60" r="8" stroke-width="2"/>
                                    </g>
                                </svg>
                            </div>
                            <div class="type-name">External Spray</div>
                        </div>
                        <div class="type-option" data-type="internalDoors" onclick="selectProjectType('internalDoors')">
                            <div class="type-icon">
                                <svg viewBox="0 0 100 100" width="40" height="40" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <defs><linearGradient id="gold-door-d" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#A3E4D7"/><stop offset="50%" stop-color="#58D68D"/><stop offset="100%" stop-color="#27AE60"/></linearGradient></defs>
                                    <g transform="translate(15, 5)" stroke="url(#gold-door-d)" fill="none">
                                        <path d="M0 90 V0 H70 V90" stroke-width="2.5" fill="url(#gold-door-d)" opacity="0.2"/>
                                        <path d="M10 10 L65 20 L65 85 L10 80 Z" stroke-width="2.5"/>
                                        <path d="M18 20 L55 28 L55 42 L18 36 Z" stroke-width="1" opacity="0.5"/>
                                        <path d="M18 50 L55 58 L55 72 L18 64 Z" stroke-width="1" opacity="0.5"/>
                                        <circle cx="52" cy="52" r="3" fill="url(#gold-door-d)"/>
                                        <rect x="52" y="50" width="10" height="3" fill="url(#gold-door-d)" rx="1"/>
                                    </g>
                                </svg>
                            </div>
                            <div class="type-name">Internal Doors</div>
                        </div>
                        <div class="type-option selected" data-type="other" onclick="selectProjectType('other')">
                            <div class="type-icon">
                                <svg viewBox="0 0 100 100" width="40" height="40" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <defs><linearGradient id="gold-other-d" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#A3E4D7"/><stop offset="50%" stop-color="#58D68D"/><stop offset="100%" stop-color="#27AE60"/></linearGradient></defs>
                                    <g transform="translate(15, 15)" stroke="url(#gold-other-d)" fill="none">
                                        <path d="M5 40 L35 10 L65 40" stroke-width="2.5"/>
                                        <rect x="12" y="40" width="46" height="35" stroke-width="2.5"/>
                                        <rect x="28" y="50" width="14" height="25" stroke-width="2" fill="url(#gold-other-d)" opacity="0.3"/>
                                        <circle cx="38" cy="62" r="2" fill="url(#gold-other-d)"/>
                                        <rect x="16" y="46" width="10" height="10" stroke-width="1.5"/>
                                        <line x1="21" y1="46" x2="21" y2="56" stroke-width="1"/>
                                        <line x1="16" y1="51" x2="26" y2="51" stroke-width="1"/>
                                    </g>
                                </svg>
                            </div>
                            <div class="type-name">Other</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Project Name</label>
                    <input type="text" id="projectName" placeholder="e.g. 4x Sash Windows">
                </div>
                
                <div class="form-group">
    <label>Client (required)</label>
    <select id="projectClient" style="width: 100%; padding: 8px; background: #3e3e42; border: 1px solid #555; color: #e8e2d5; border-radius: 3px;" onchange="loadClientContacts()">
        <option value="">-- Select client from database --</option>
    </select>
    <button type="button" onclick="window.open('clients.html', '_blank')" style="margin-top: 5px; padding: 5px 10px; background: #007acc; border: none; color: white; border-radius: 3px; cursor: pointer;">
        + Add new client
    </button>
</div>
                
                <div class="form-group" id="projectContactGroup" style="display: none;">
    <label>Project Contact</label>
    <select id="projectContact" style="width: 100%; padding: 8px; background: #3e3e42; border: 1px solid #555; color: #e8e2d5; border-radius: 3px;">
        <option value="">-- Main contact --</option>
    </select>
</div>
                
                <div class="form-group">
                    <label>Start Date</label>
                    <input type="date" id="projectStartDate">
                </div>
                
                <div class="form-group">
                    <label>Deadline (optional - for production scheduling)</label>
                    <input type="date" id="projectDeadline">
                </div>
                
                <div class="form-group">
                    <label>Select Phases (uncheck unwanted phases)</label>
                    <div class="phase-list" id="phasesList">
                        <!-- Phase checkboxes will be added here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn" onclick="closeModal('projectModal')">Cancel</button>
                <button class="modal-btn primary" onclick="saveProject()">Save</button>
            </div>
        </div>
    </div>

    <!-- Phase Edit Modal -->
    <div class="modal" id="phaseEditModal">
        <div class="modal-content">
            <div class="modal-header" id="phaseEditTitle">Edit Phase</div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Phase Status</label>
                    <select id="phaseStatus">
                        <option value="notStarted">‚è∏Ô∏è Not Started</option>
                        <option value="inProgress">‚ñ∂Ô∏è In Progress</option>
                        <option value="completed">‚úÖ Completed</option>
                        <option value="problem">‚ö†Ô∏è Problem/Delayed</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Duration (work days, excluding Sundays)</label>
                    <input type="number" id="phaseDuration" min="1" value="3">
                </div>
                
                <div class="form-group" id="assignSection" style="display: none;">
                    <label>Assign Team Member</label>
                    <select id="phaseAssignSelect">
                        <option value="">None</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="phaseNotes" placeholder="Add any notes about this phase..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn danger" id="deletePhaseBtn" onclick="deleteCurrentPhase()" style="margin-right: auto;">Delete Phase</button>
                <button class="modal-btn" id="addSegmentBtn" onclick="addPhaseSegment()" style="background: #2196F3; color: white; display: none;">+ Add Segment</button>
                <button class="modal-btn" onclick="closeModal('phaseEditModal')">Cancel</button>
                <button class="modal-btn primary" onclick="savePhaseChanges()">Save</button>
            </div>
        </div>
    </div>

    <!-- Order Materials Modal -->
    <div class="modal" id="orderMaterialsModal">
        <div class="modal-content">
            <div class="modal-header">Edit Order Materials</div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Phase Status</label>
                    <select id="orderMaterialsStatus">
                        <option value="notStarted">‚è∏Ô∏è Not Started</option>
                        <option value="inProgress">‚ñ∂Ô∏è In Progress</option>
                        <option value="completed">‚úÖ Completed</option>
                        <option value="problem">‚ö†Ô∏è Problem/Delayed</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Duration (work days, excluding Sundays)</label>
                    <input type="number" id="orderDuration" min="1" value="3">
                </div>
                
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="orderMaterialsNotes" placeholder="Add any notes about this phase..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn danger" onclick="deleteOrderPhase()" style="margin-right: auto;">Delete Phase</button>
                <button class="modal-btn" onclick="closeModal('orderMaterialsModal')">Cancel</button>
                <button class="modal-btn primary" onclick="saveOrderMaterialsPhase()">Save</button>
            </div>
        </div>
    </div>

    <!-- Order Spray Materials Modal -->
    <div class="modal" id="orderSprayModal">
        <div class="modal-content">
            <div class="modal-header">Edit Order Spray Materials</div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Phase Status</label>
                    <select id="orderSprayStatus">
                        <option value="notStarted">‚è∏Ô∏è Not Started</option>
                        <option value="inProgress">‚ñ∂Ô∏è In Progress</option>
                        <option value="completed">‚úÖ Completed</option>
                        <option value="problem">‚ö†Ô∏è Problem/Delayed</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Duration (work days, excluding Sundays)</label>
                    <input type="number" id="sprayOrderDuration" min="1" value="2">
                </div>
                
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="orderSprayNotes" placeholder="Add any notes about this phase..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn danger" onclick="deleteOrderSprayPhase()" style="margin-right: auto;">Delete Phase</button>
                <button class="modal-btn" onclick="closeModal('orderSprayModal')">Cancel</button>
                <button class="modal-btn primary" onclick="saveOrderSprayPhase()">Save</button>
            </div>
        </div>
    </div>

    <!-- Order Glazing Modal -->
    <div class="modal" id="orderGlazingModal">
        <div class="modal-content">
            <div class="modal-header">Edit Order Glazing</div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Phase Status</label>
                    <select id="orderGlazingStatus">
                        <option value="notStarted">‚è∏Ô∏è Not Started</option>
                        <option value="inProgress">‚ñ∂Ô∏è In Progress</option>
                        <option value="completed">‚úÖ Completed</option>
                        <option value="problem">‚ö†Ô∏è Problem/Delayed</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Duration (work days, excluding Sundays)</label>
                    <input type="number" id="glazingOrderDuration" min="1" value="2">
                </div>
                
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="orderGlazingNotes" placeholder="Add any notes about this phase..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn danger" onclick="deleteOrderGlazingPhase()" style="margin-right: auto;">Delete Phase</button>
                <button class="modal-btn" onclick="closeModal('orderGlazingModal')">Cancel</button>
                <button class="modal-btn primary" onclick="saveOrderGlazingPhase()">Save</button>
            </div>
        </div>
    </div>

    <!-- Days Off Modal -->

    <!-- Phase Manager Modal -->
    <div class="modal" id="phaseModal">
        <div class="modal-content" style="width: 500px;">
            <div class="modal-header">Manage Phases</div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Add Custom Phase</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="newPhaseName" placeholder="Phase name">
                        <input type="color" id="newPhaseColor" value="#4a90e2">
                        <button class="modal-btn primary" onclick="addCustomPhase()">Add</button>
                    </div>
                    <small style="color: #888; margin-top: 5px; display: block;">‚ö†Ô∏è Custom phases are not included in accounting calculations</small>
                </div>
                <div class="form-group">
                    <label>Available Phases</label>
                    <div id="availablePhases">
                        <!-- Phases list will be shown here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn primary" onclick="closeModal('phaseModal')">Done</button>
            </div>
        </div>
    </div>

   
    <!-- Move to Archive Modal -->
    <div class="modal" id="moveToArchiveModal">
        <div class="modal-content">
            <div class="modal-header">Move to Archive</div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Select Completed Project to Archive</label>
                    <select id="completedProjectSelect" style="width: 100%; padding: 8px;">
                        <option value="">Select project...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Archive Reason</label>
                    <select id="archiveReason" style="width: 100%; padding: 8px;" onchange="toggleBudgetConfirmation()">
                        <option value="completed">‚úÖ Project Completed Successfully</option>
                        <option value="cancelled">‚ùå Project Cancelled</option>
                        <option value="onHold">‚è∏Ô∏è Project On Hold</option>
                    </select>
                </div>
                
                <div id="budgetConfirmationSection" class="form-group" style="border: 2px solid #4ade80; padding: 15px; border-radius: 5px; background: #1a2f1a;">
                    <label style="color: #4ade80; font-weight: bold;">üí∞ Budget Confirmation (Completed Projects Only)</label>
                    
                    <div style="margin: 10px 0;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="budgetSameAsQuote" checked onchange="toggleActualValueField()" style="margin-right: 10px; width: 20px; height: 20px;">
                            <span>Budget was the same as in the quote</span>
                        </label>
                    </div>
                    
                    <div id="actualValueField" class="form-group" style="display: none; margin-top: 10px;">
                        <label>Actual Final Value (¬£)</label>
                        <input type="number" id="actualFinalValue" step="0.01" min="0" placeholder="e.g. 14500">
                        <small style="color: #999; display: block; margin-top: 5px;">
                            Enter the final value if different from the original contract value
                        </small>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Additional Notes (optional)</label>
                    <textarea id="archiveNotes" placeholder="Any additional notes about archiving this project..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn" onclick="closeModal('moveToArchiveModal')">Cancel</button>
                <button class="modal-btn success" onclick="confirmMoveToArchive()">Move to Archive</button>
            </div>
        </div>
    </div>

    <!-- Materials List Modal -->
    <!-- Add Material Modal -->
    <div id="addMaterialModal" class="modal">
        <div class="modal-content" style="width: 600px; max-width: 90%;">
            <div class="modal-header">
                <h2>Add Material</h2>
                <button class="modal-close" onclick="closeAddMaterialModal()">√ó</button>
            </div>
            <div class="modal-body">
                <!-- Edit Material Info (hidden by default, shown in edit mode) -->
                <div id="editMaterialInfo" style="display: none; margin-bottom: 20px; padding: 16px; background: #1a1a1a; border-radius: 8px; border: 1px solid #404040;">
                    <div style="display: flex; gap: 16px; align-items: center;">
                        <img id="editMaterialImage" src="" style="width: 60px; height: 60px; object-fit: cover; border-radius: 4px; display: none;">
                        <div id="editMaterialImagePlaceholder" style="width: 60px; height: 60px; background: #2d2d2d; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 24px; display: none;">üì¶</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #e0e0e0; margin-bottom: 4px;" id="editMaterialName"></div>
                            <div style="font-size: 13px; color: #999;" id="editMaterialCategory"></div>
                            <div style="font-size: 12px; color: #666; margin-top: 4px;">
                                <span>Item#: <span id="editMaterialItemNumber" style="color: #999;"></span></span>
                                <span style="margin-left: 12px;">Current Reserved: <span id="editMaterialReserved" style="color: #10b981;"></span></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Stage Selection -->
                <div class="form-group">
                    <label>Stage <span style="color: #ff6b6b;">*</span></label>
                    <select id="addMaterialStage" onchange="onStageChange()">
                        <option value="">-- Select Stage --</option>
                        <option value="Production">üì¶ Production</option>
                        <option value="Spraying">üé® Spraying</option>
                        <option value="Installation">üîß Installation</option>
                    </select>
                </div>

                <!-- Material Type -->
                <div class="form-group">
                    <label>Material Type <span style="color: #ff6b6b;">*</span></label>
                    <div style="display: flex; gap: 15px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="radio" name="materialType" value="stock" checked onchange="onMaterialTypeChange()" style="margin-right: 8px;">
                            <span>From Stock</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="radio" name="materialType" value="bespoke" onchange="onMaterialTypeChange()" style="margin-right: 8px;">
                            <span>Bespoke (Custom)</span>
                        </label>
                    </div>
                </div>

                <!-- Stock Item Selection -->
                <div id="stockItemSection">
                    <!-- Category -->
                    <div class="form-group">
                        <label>Category <span style="color: #ff6b6b;">*</span></label>
                        <select id="addMaterialCategory" onchange="onCategoryChange()">
                            <option value="">-- Select Category --</option>
                        </select>
                    </div>

                    <!-- Subcategory -->
                    <div class="form-group" id="subcategoryGroup" style="display: none;">
                        <label>Subcategory <span style="color: #ff6b6b;">*</span></label>
                        <select id="addMaterialSubcategory" onchange="onSubcategoryChange()">
                            <option value="">-- Select Subcategory --</option>
                        </select>
                    </div>

                    <!-- Stock Item -->
                    <div class="form-group" id="stockItemGroup" style="display: none;">
                        <label>Stock Item <span style="color: #ff6b6b;">*</span></label>
                        <select id="addMaterialStockItem" onchange="onStockItemChange()">
                            <option value="">-- Select Item --</option>
                        </select>
                        <div id="stockItemInfo" style="margin-top: 10px; padding: 10px; background: #1a1a1a; border-radius: 4px; display: none;">
                            <div style="font-size: 12px; color: #aaa;">
                                <div><strong>In Stock:</strong> <span id="itemInStock">-</span></div>
                                <div><strong>Unit:</strong> <span id="itemUnit">-</span></div>
                                <div><strong>Cost per Unit:</strong> <span id="itemCost">-</span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bespoke Item Section -->
                <div id="bespokeItemSection" style="display: none;">
                    <div class="form-group">
                        <label>Item Name <span style="color: #ff6b6b;">*</span></label>
                        <input type="text" id="bespokeItemName" placeholder="e.g. Custom brass handles Victorian style">
                    </div>

                    <div class="form-group">
                        <label>Category <span style="color: #ff6b6b;">*</span></label>
                        <select id="bespokeMaterialCategory">
                            <option value="">-- Select Category --</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="bespokeDescription" rows="3" placeholder="Detailed description of bespoke item..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>Supplier</label>
                        <select id="bespokeSupplier">
                            <option value="">-- Select Supplier --</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Purchase Link (optional)</label>
                        <input type="url" id="bespokePurchaseLink" placeholder="https://...">
                    </div>

                    <div class="form-group">
                        <label>Unit Cost (¬£) <span style="color: #ff6b6b;">*</span></label>
                        <input type="number" id="bespokeUnitCost" step="0.01" min="0" placeholder="0.00">
                    </div>

                    <div class="form-group">
                        <label>Image (optional)</label>
                        <input type="file" id="bespokeImageUpload" accept="image/*" style="padding: 8px; background: #2a2a2a; border: 1px solid #404040; border-radius: 4px; color: #e0e0e0;">
                        <div id="bespokeImagePreview" style="margin-top: 10px; display: none;">
                            <img id="bespokeImagePreviewImg" style="max-width: 200px; max-height: 200px; border-radius: 4px; border: 1px solid #404040;">
                        </div>
                    </div>
                </div>

                <!-- Quantity & Unit -->
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Quantity Needed <span style="color: #ff6b6b;">*</span></label>
                        <input type="number" id="addMaterialQuantity" step="0.01" min="0.01" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label>Unit <span style="color: #ff6b6b;">*</span></label>
                        <input type="text" id="addMaterialUnit" placeholder="pcs, m, L" maxlength="10">
                    </div>
                </div>

                <!-- Notes -->
                <div class="form-group">
                    <label>Notes (optional)</label>
                    <textarea id="addMaterialNotes" rows="2" placeholder="e.g. Ask for Grade A, Same batch as previous project..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn" onclick="closeAddMaterialModal()">Cancel</button>
                <button class="modal-btn primary" onclick="saveMaterial()">Add Material</button>
            </div>
        </div>
    </div>

    <!-- Hidden file input -->
    <input type="file" id="fileInput" accept=".json" style="display: none;">

    <!-- Scripts in correct order -->
    <script src="js/utils.js?v=6"></script>
    <script src="js/calendar.js?v=6"></script>
    <script src="js/project-icons.js?v=3"></script>
    <script src="js/data.js?v=6"></script>
    <script src="js/project-numbering.js?v=1"></script>
    <script src="js/team.js?v=6"></script>
    <script src="js/pdf-branding.js"></script>
    <script src="js/projects.js?v=6"></script>
    <script src="js/phases.js?v=6"></script>
    <script src="js/drag.js?v=7"></script>
    <script src="js/gantt.js?v=17"></script>
    <script src="js/modals.js?v=6"></script>
    <script src="js/project-files.js?v=6"></script>
    <script src="js/order-duration-fixes.js?v=6"></script> 
    <script src="js/sticky-fix.js?v=6"></script>
    <script src="js/google-drive-picker.js?v=6"></script>
    <script src="js/sort-filter.js?v=6"></script>
    <script src="js/app.js?v=6"></script>
    <script src="js/materials-templates.js?v=1"></script>
    <script src="js/materials-functions.js?v=1"></script>
    
    <!-- Load Materials Modal -->
    <div id="materialsModalContainer"></div>
    <script>
        // Load materials-modal.html into DOM
        fetch('materials-modal.html')
            .then(response => response.text())
            .then(html => {
                document.getElementById('materialsModalContainer').innerHTML = html;
            })
            .catch(err => console.error('Error loading materials modal:', err));
    </script>

    <!-- Pipeline Recommendation Modal -->
    <div class="modal" id="pipelineRecommendationModal">
        <div class="modal-content" style="max-width: 500px; text-align: center;">
            <div class="modal-body" style="padding: 30px;">
                <img src="landingimg/logo.webp" alt="Joinery Core" style="height: 60px; margin-bottom: 20px; border-radius: 8px;">
                <h3 style="color: #D4AF37; margin-bottom: 15px;">üí° Recommendation</h3>
                <p style="color: #ccc; line-height: 1.6; margin-bottom: 20px;">
                    We recommend adding projects through <strong style="color: #D4AF37;">Pipeline</strong> first, 
                    especially if they are not yet confirmed by the client or contracts are not signed.
                </p>
                <p style="color: #888; font-size: 13px; margin-bottom: 25px;">
                    All information and files will be automatically transferred to Production after approval.
                </p>
                <div style="display: flex; gap: 12px; justify-content: center;">
                    <button class="modal-btn" onclick="window.location.href='pipeline.html'" style="background: linear-gradient(135deg, #D4AF37, #B8963E); color: #000; font-weight: 600; padding: 12px 24px;">
                        Go to Pipeline
                    </button>
                    <button class="modal-btn" onclick="closePipelineRecommendation(); openAddProjectDirect();" style="background: #333; color: #ccc; padding: 12px 24px;">
                        Continue Anyway
                    </button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>